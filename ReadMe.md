# Raph — Конфигуратор реактивного многофазного графа

**Что это и зачем?**

**Raph** — это библиотека реактивности, построенная вокруг идей графа зависимостей и маршрутизации по путям данных.
Она решает задачу связывания данных и эффектов в сложных приложениях, где обычной модели сигналов/эффектов недостаточно.

**Основные цели:**

- **Динамическая реактивность** — данные описываются путями (DataPath), можно подписываться на любые ветви.
- **Высокая производительность** — хранение зависимостей в дереве маршрутов, кэширование и оптимизированные обходы.
- **Гибкая архитектура** — ноды, фазы, маршрутизатор разделены на отдельные части.
- **Прозрачность** — легко отлаживать, так как зависимости представлены явным графом.

---

## Архитектура

**Raph** состоит из нескольких ключевых модулей:

- **RaphApp** — корневое приложение, регистрирует фазы и управляет графом.
- **RaphNode** — вычислительный узел графа (сущность, которая участвует в реактивности).
- **RaphRouter** — маршрутизатор для путей данных, поддерживающий * и параметризованные сегменты (id=$x).
- **Phases** — механизм выполнения задач в разных стратегиях (dirty-only, dirty-and-down и т.д.).

---

## Модули

#### RaphApp

**Корневой объект. Отвечает за:**

- регистрацию фаз (definePhases)
- хранение всех нод (addNode, removeNode)
- обработку изменений (set, dirty)
- координацию с маршрутизатором

**Пример**:

```ts 
const app = new RaphApp()
app.definePhases([
    {
        name: 'watch',
        traversal: 'dirty-only',
        executor: (ctx) => {
            console.log('Triggered:', ctx.node.id, ctx.event)
        },
        routes: ['data.*'],
    },
])
```

---

#### RaphNode

Узел графа реактивности.

**Возможности**:

- Имеет уникальный id.
- Может быть родителем/потомком (addChild).
- Отмечается грязным при изменениях.
- Может исполняться в фазах.

Пример:

```ts 
const node = new RaphNode(app, {id: 'n1'})
app.addNode(node)
```

---

#### RaphRouter

Маршрутизатор путей. Использует trie-подобное дерево (RouterNode) для хранения подписок.

**Поддерживает**:

- точные ключи: user.name
- wildcard: user.*
- deep wildcard: user.* в конце
- параметры:
- литералы: orders[id=123].total
- плейсхолдеры: orders[id=$oid].items[id=$id]

**Пример**:

```ts 
const r = new RaphRouter<string>()
r.add('orders[id=$oid].items[id=$iid].price', 'PriceWatch')

const hits = r.matchWithParams('orders[id=10].items[id=5].price')
// => [{ payload: 'PriceWatch', params: { oid: '10', iid: '5' } }]

```

#### Фазы

**Фаза** — это стратегия выполнения нод. Определяет:

- Как выбираются ноды (routes)
- Как они исполняются (executor)
- Как проходит обход (traversal)

Варианты traversal:

- dirty-only — только изменённые ноды.
- dirty-and-down — нода и все её потомки.
- up-and-dirty — все предки плюс сама нода.

**Пример**:

```ts 
app.definePhases([
    {
        name: 'render',
        traversal: 'dirty-and-down',
        executor: (ctx) => {
            console.log('Render node', ctx.node.id)
        },
        routes: ['ui.*'],
    },
])
```


# Быстрый старт

```bash
npm install @endge/raph
```

# Development

Библиотека находится в активной разработке.
